<!DOCTYPE html>
<html>
<head>
<title>osmgress</title>
<link rel="stylesheet"
	href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<style type="text/css">
html,body {
	margin: 0;
	padding: 0;
	height: 100%;
}

#map {
	min-height: 100%;
	height: auto !important;
	height: 100%;
	overflow: hidden !important;
}
</style>
</head>
<body>
	<div id="map"></div>
	<script type="text/javascript">

		var blue8 = L.icon({
			iconUrl: 'images/blue8_32.png',
			iconRetinaUrl: 'images/blue8_64.png',
		    iconSize: [32, 32],
		    iconAnchor: [16, 16],
		    popupAnchor: [0, -20]
		});
		var green8 = L.icon({
			iconUrl: 'images/green8_32.png',
			iconRetinaUrl: 'images/green8_64.png',
		    iconSize: [32, 32],
		    iconAnchor: [16, 16],
		    popupAnchor: [0, -20]
		});
		var gray8 = L.icon({
			iconUrl: 'images/gray8_32.png',
			iconRetinaUrl: 'images/gray8_64.png',
		    iconSize: [32, 32],
		    iconAnchor: [16, 16],
		    popupAnchor: [0, -20]
		});

		var map;
		var lookup = {};

		function toIcon(faction) {
			if (faction == 'blue') {
				return blue8;
			} else if (faction == 'green') {
				return green8;
			} else {
				return gray8;
			}
		}

		function load(map) {
			var bounds = map.getBounds();
			$.getJSON("query?lat_min=" + bounds.getSouth() + "&lat_max="
					+ bounds.getNorth() + "&lon_min=" + bounds.getWest()
					+ "&lon_max=" + bounds.getEast(), function(data) {
				$.each(data, function(key, val) {
					if (lookup[val.id] == undefined) {
						var marker = L.marker([ val.latitude, val.longitude ], {icon: toIcon(val.faction)})
								.addTo(map);
						if (val.name != undefined) {
							marker.bindPopup("<b>" + val.name + "</b>");
						}
						lookup[val.id] = marker;
					}
				});
			});
		}

		function zoomToPosition(position) {
			map
					.setView([ position.coords.latitude,
							position.coords.longitude ], 13);
		}

		$(function() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(zoomToPosition);
			}

			map = L.map('map').setView([ 50.356718, 7.599485 ], 13);
			L
					.tileLayer(
							'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
							{
								attribution : 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
								maxZoom : 18
							}).addTo(map);

			load(map);

			map.on('moveend', function(e) {
				load(map);
			});

		});
	</script>
</body>
</html>